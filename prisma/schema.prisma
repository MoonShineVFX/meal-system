generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["filteredRelationCount"]
}

// generator dbml {
//   provider = "prisma-dbml-generator"
// }

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "foreignKeys"
}

// User
enum UserRole {
  ADMIN
  STAFF
  USER
}

model UserToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String
}

model User {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name          String
  role          UserRole @default(USER)
  pointBalance  Int      @default(500)
  creditBalance Int      @default(0)
  password      String?

  cartItems          CartItem[]
  tokens             UserToken[]
  orders             Order[]
  twmpDeposits       TwmpDeposit[]
  ethWallet          EthWallet?
  sourceTransactions Transaction[] @relation("source")
  targetTransactions Transaction[] @relation("target")
}

// Transaction
enum TransactionType {
  RECHARGE // Server modify balance
  REFUND
  PAYMENT // User pay/order for something
  TRANSFER // User transfer balance to another user
}

model Transaction {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  type         TransactionType
  pointAmount  Int             @default(0)
  creditAmount Int             @default(0)

  sourceUser   User        @relation("source", fields: [sourceUserId], references: [id])
  sourceUserId String
  targetUser   User        @relation("target", fields: [targetUserId], references: [id])
  targetUserId String
  order        Order?      @relation(fields: [orderId], references: [id])
  orderId      Int?
  twmpResult   TwmpResult? @relation(fields: [twmpResultId], references: [txnUID])
  twmpResultId String?
  ethHashes    String[]
}

// TWMP
enum TwmpResultStatus {
  SUCCESS
  FAILED
  CANCELED
}

model TwmpResult {
  txnUID    String   @id
  createdAt DateTime
  updatedAt DateTime @updatedAt

  status TwmpResultStatus

  transactions Transaction[]
  deposit      TwmpDeposit   @relation(fields: [depositId], references: [orderNo])
  depositId    String
}

model TwmpDeposit {
  orderNo   String   @id @default(cuid())
  createdAt DateTime @default(now())

  transAMT    Int
  txnID       String? @unique
  callbackUrl String?
  qrcode      String?

  results TwmpResult[]
  user    User         @relation(fields: [userId], references: [id])
  userId  String
}

// Blockchain
model EthWallet {
  address String @id

  privateKey String? @unique

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

// Order
enum OrderStatus {
  PENDING
  COMPLETED
  CANCELED
}

model Order {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status OrderStatus @default(PENDING)

  user         User          @relation(fields: [userId], references: [id])
  userId       String
  items        OrderItem[]
  transactions Transaction[]
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  name    String
  price   Int
  options String[]

  order           Order           @relation(fields: [orderId], references: [id])
  orderId         Int
  commodityOnMenu CommodityOnMenu @relation(fields: [menuId, commodityId], references: [menuId, commodityId])
  menuId          Int
  commodityId     Int
  image           Image?          @relation(fields: [imageId], references: [id])
  imageId         String?
}

model CartItem {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  options String[]

  user            User            @relation(fields: [userId], references: [id])
  userId          String
  commodityOnMenu CommodityOnMenu @relation(fields: [menuId, commodityId], references: [menuId, commodityId], onDelete: Cascade)
  menuId          Int
  commodityId     Int
}

// Menu
model CommodityCategory {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mainName String
  subName  String

  commodities Commodity[]

  @@unique([mainName, subName])
}

model CommodityOptionSetTemplate {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  multiSelect Boolean
  options     String[]
}

model Commodity {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  description String @default("")
  price       Int

  optionSets Json    @db.Json // { "name": string, "multiSelect": boolean, "options": string[] }[]
  isDeleted  Boolean @default(false)

  categories CommodityCategory[]
  image      Image?              @relation(fields: [imageId], references: [id])
  imageId    String?
  onMenus    CommodityOnMenu[]
}

// Menu
model CommodityOnMenu {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  limitPerUser Int     @default(0)
  SKU          Int     @default(0)
  isDeleted    Boolean @default(false)

  commodity   Commodity   @relation(fields: [commodityId], references: [id])
  commodityId Int
  menu        Menu        @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId      Int
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@id([menuId, commodityId])
}

enum MenuType {
  BREAKFAST
  LUNCH
  DINNER
  TEA
  MAIN
}

model Menu {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  date          DateTime? @db.Date
  type          MenuType
  name          String    @default("")
  description   String    @default("")
  publishedDate DateTime?
  closedDate    DateTime?
  limitPerUser  Int       @default(0)
  isDeleted     Boolean   @default(false)

  commodities CommodityOnMenu[]
}

// Resource
model Image {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  path   String
  width  Int
  height Int

  Commodity Commodity[]
  OrderItem OrderItem[]
}
