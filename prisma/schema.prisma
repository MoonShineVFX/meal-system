generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["filteredRelationCount"]
}

// generator dbml {
//   provider = "prisma-dbml-generator"
// }

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "foreignKeys"
}

// User
enum UserRole {
  ADMIN
  STAFF
  USER
}

model UserToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String
}

model User {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name                  String
  role                  UserRole  @default(USER)
  pointBalance          Int       @default(500)
  creditBalance         Int       @default(0)
  password              String?
  lastPointRechargeTime DateTime?

  profileImage       Image?        @relation(fields: [profileImageId], references: [id])
  profileImageId     String?       @unique
  cartItems          CartItem[]
  tokens             UserToken[]
  orders             Order[]
  twmpDeposits       TwmpDeposit[]
  ethWallet          EthWallet?
  sourceTransactions Transaction[] @relation("source")
  targetTransactions Transaction[] @relation("target")
}

// Transaction
enum TransactionType {
  RECHARGE // Server modify balance
  PAYMENT // User pay/order for something
  CANCELED // Staff cancel order
  TRANSFER // User transfer balance to another user
  REFUND // User ask for refund with twmp
}

model Transaction {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  type         TransactionType
  pointAmount  Int             @default(0)
  creditAmount Int             @default(0)

  sourceUser   User   @relation("source", fields: [sourceUserId], references: [id])
  sourceUserId String
  targetUser   User   @relation("target", fields: [targetUserId], references: [id])
  targetUserId String

  twmpResult       TwmpResult? @relation(fields: [twmpResultId], references: [txnUID])
  twmpResultId     String?
  ethHashes        String[]
  ordersForPayment Order[]     @relation("orderPayment")
  orderForCanceled Order?      @relation("canceledPayment")

  @@index([sourceUserId, targetUserId, type, createdAt(sort: Desc)])
}

// TWMP
enum TwmpResultStatus {
  SUCCESS
  FAILED
  CANCELED
}

model TwmpResult {
  txnUID    String   @id
  createdAt DateTime
  updatedAt DateTime @updatedAt

  status TwmpResultStatus

  transactions Transaction[]
  deposit      TwmpDeposit   @relation(fields: [depositId], references: [orderNo])
  depositId    String
}

model TwmpDeposit {
  orderNo   String   @id @default(cuid())
  createdAt DateTime @default(now())

  transAMT    Int
  txnID       String? @unique
  callbackUrl String?
  qrcode      String?

  results TwmpResult[]
  user    User         @relation(fields: [userId], references: [id])
  userId  String
}

// Blockchain
model EthWallet {
  address String @id

  privateKey String? @unique

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

model Order {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  timePreparing DateTime?
  timeDishedUp  DateTime?
  timeCompleted DateTime?
  timeCanceled  DateTime?

  user   User        @relation(fields: [userId], references: [id])
  userId String
  menu   Menu        @relation(fields: [menuId], references: [id])
  menuId Int
  items  OrderItem[]

  paymentTransaction    Transaction? @relation("orderPayment", fields: [paymentTransactionId], references: [id])
  paymentTransactionId  Int?
  canceledTransaction   Transaction? @relation("canceledPayment", fields: [canceledTransactionId], references: [id])
  canceledTransactionId Int?         @unique

  @@index([userId, menuId, timePreparing(sort: Desc), createdAt(sort: Desc)])
  @@index([menuId, timeCompleted, timeCanceled, createdAt(sort: Desc)])
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  name     String
  price    Int
  quantity Int
  options  Json   @db.Json // { "optionName": string | string[]}

  order           Order           @relation(fields: [orderId], references: [id])
  orderId         Int
  commodityOnMenu CommodityOnMenu @relation(fields: [menuId, commodityId], references: [menuId, commodityId])
  menuId          Int
  commodityId     Int
  image           Image?          @relation(fields: [imageId], references: [id])
  imageId         String?

  @@index([orderId, menuId, commodityId])
}

model CartItem {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quantity   Int
  options    Json    @db.Json // { "optionName": string | string[]}
  optionsKey String
  invalid    Boolean @default(false)

  user            User            @relation(fields: [userId], references: [id])
  userId          String
  commodityOnMenu CommodityOnMenu @relation(fields: [menuId, commodityId], references: [menuId, commodityId], onDelete: Cascade)
  menuId          Int
  commodityId     Int

  @@id([userId, menuId, commodityId, optionsKey])
  @@index([userId, menuId, commodityId, invalid])
}

// Menu
model CommodityCategory {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mainName  String
  subName   String
  mainOrder Int    @default(99)
  subOrder  Int    @default(99)

  commodities Commodity[]

  @@unique([mainName, subName])
}

model CommodityOptionSetTemplate {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  multiSelect Boolean
  options     String[]
}

model Commodity {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String
  description String @default("")
  price       Int

  optionSets Json    @db.Json // { "name": string, "multiSelect": boolean, "options": string[], "order": number }[]
  isDeleted  Boolean @default(false)

  categories CommodityCategory[]
  image      Image?              @relation(fields: [imageId], references: [id])
  imageId    String?
  onMenus    CommodityOnMenu[]

  @@index([id, isDeleted])
}

// Menu
model CommodityOnMenu {
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  limitPerUser Int     @default(0)
  stock        Int     @default(0)
  isDeleted    Boolean @default(false)

  commodity   Commodity   @relation(fields: [commodityId], references: [id])
  commodityId Int
  menu        Menu        @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId      Int
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@id([menuId, commodityId])
  @@index([menuId, commodityId, isDeleted])
}

enum MenuType {
  BREAKFAST
  LUNCH
  DINNER
  TEA
  LIVE
  RETAIL
}

model Menu {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  date          DateTime?
  type          MenuType
  name          String    @default("")
  description   String    @default("")
  publishedDate DateTime?
  closedDate    DateTime?
  limitPerUser  Int       @default(0)
  isDeleted     Boolean   @default(false)

  commodities CommodityOnMenu[]
  orders      Order[]

  @@index([date, type, isDeleted, createdAt(sort: Desc)])
  @@index([id, isDeleted, createdAt(sort: Desc)])
}

// Resource
model Image {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  path   String
  width  Int
  height Int

  Commodity Commodity[]
  OrderItem OrderItem[]
  User      User?
}

// Setting
enum SettingType {
  STRING
  INT
  BOOLEAN
  JSON
}

model Setting {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  key   String
  value String
  type  SettingType

  @@unique([key])
}

// Server Refill
model ServerRefill {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  date   DateTime
  amount Int
}
